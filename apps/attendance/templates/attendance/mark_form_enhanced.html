{% extends "base_authenticated.html" %}
{% load static %}

{% block title %}Mark Attendance - Disha LMS{% endblock %}

{% block extra_head %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<style>
.select2-container--default .select2-selection--single,
.select2-container--default .select2-selection--multiple {
    border: 1px solid hsl(var(--bc) / 0.2);
    border-radius: 0.5rem;
    min-height: 3rem;
    padding: 0.5rem;
}
.select2-container--default .select2-selection--single .select2-selection__rendered {
    line-height: 2rem;
    padding-left: 0.5rem;
}
.select2-container--default .select2-selection--multiple .select2-selection__choice {
    background-color: hsl(var(--p));
    color: hsl(var(--pc));
    border: none;
    border-radius: 0.375rem;
    padding: 0.25rem 0.5rem;
    margin: 0.25rem;
}
.select2-container { width: 100% !important; }
.select2-dropdown {
    border: 1px solid hsl(var(--bc) / 0.2);
    border-radius: 0.5rem;
}
</style>
{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="mb-4">
        {% if is_backdate_mode %}
        <h1 class="h1 fw-bold">ðŸ“… Backdate Attendance</h1>
        <p class="text-muted">{{ page_description|default:"Create backdated attendance records with typeahead search" }}</p>
        {% else %}
        <h1 class="h1 fw-bold">âš¡ Quick Attendance</h1>
        <p class="text-muted">Fast typeahead search - Auto-filtering topics</p>
        <div class="alert alert-info mt-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            <span>After marking attendance, check <a href="{% url 'attendance:today' %}" class="link link-primary">Today's Attendance</a> to see your marked records.</span>
        </div>
        {% endif %}
    </div>
    
    <div class="card shadow">
        <div class="card-body">
            <form method="post" id="attendanceForm">
                {% csrf_token %}
                
                {% if form.non_field_errors %}
                <div class="alert alert-error mb-4">
                    <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>{{ form.non_field_errors }}</span>
                </div>
                {% endif %}
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Student *</span>
                            <span class="label-text-alt text-info">Type to search</span>
                        </label>
                        {{ form.student }}
                        {% if form.student.errors %}
                        <label class="label">
                            <span class="label-text-alt text-error">{{ form.student.errors.0 }}</span>
                        </label>
                        {% endif %}
                        {% if form.student.help_text %}
                        <label class="label">
                            <span class="label-text-alt">{{ form.student.help_text }}</span>
                        </label>
                        {% endif %}
                    </div>
                    
                    <div class="form-control">
                        <label class="label">
                            <span class="label-text font-semibold">Subject *</span>
                            <span class="label-text-alt text-info">Auto-filtered by student</span>
                        </label>
                        {{ form.assignment }}
                        <div id="subjectsLoadingMessage" class="text-sm text-info mt-2" style="display:none;">
                            <span class="loading loading-spinner loading-xs"></span> Loading subjects...
                        </div>
                        {% if form.assignment.errors %}
                        <label class="label">
                            <span class="label-text-alt text-error">{{ form.assignment.errors.0 }}</span>
                        </label>
                        {% endif %}
                    </div>                    
                    <div class="form-control">
                        <label class="label"><span class="label-text font-semibold">Date *</span></label>
                        {{ form.date }}
                        {% if form.date.errors %}
                        <label class="label">
                            <span class="label-text-alt text-error">{{ form.date.errors.0 }}</span>
                        </label>
                        {% endif %}
                    </div>
                    
                    <div class="form-control">
                        <label class="label"><span class="label-text font-semibold">Status *</span></label>
                        {{ form.status }}
                        {% if form.status.errors %}
                        <label class="label">
                            <span class="label-text-alt text-error">{{ form.status.errors.0 }}</span>
                        </label>
                        {% endif %}
                    </div>
                    
                    <div class="form-control">
                        <label class="label"><span class="label-text font-semibold">In Time *</span></label>
                        {{ form.in_time }}
                        {% if form.in_time.errors %}
                        <label class="label">
                            <span class="label-text-alt text-error">{{ form.in_time.errors.0 }}</span>
                        </label>
                        {% endif %}
                    </div>
                    
                    <div class="form-control">
                        <label class="label"><span class="label-text font-semibold">Out Time *</span></label>
                        {{ form.out_time }}
                        {% if form.out_time.errors %}
                        <label class="label">
                            <span class="label-text-alt text-error">{{ form.out_time.errors.0 }}</span>
                        </label>
                        {% endif %}
                    </div>
                </div>
                
                <div class="form-control mt-4">
                    <label class="label">
                        <span class="label-text font-semibold">Topics Covered</span>
                        <span class="label-text-alt text-info">Auto-filtered by subject</span>
                    </label>
                    {{ form.topics_covered }}
                    <div id="topicsLoadingMessage" class="text-sm text-info mt-2" style="display:none;">
                        <span class="loading loading-spinner loading-xs"></span> Loading topics...
                    </div>
                    {% if form.topics_covered.errors %}
                    <label class="label">
                        <span class="label-text-alt text-error">{{ form.topics_covered.errors.0 }}</span>
                    </label>
                    {% endif %}
                </div>
                
                <div class="form-control mt-4">
                    <label class="label"><span class="label-text font-semibold">Notes</span></label>
                    {{ form.notes }}
                    {% if form.notes.errors %}
                    <label class="label">
                        <span class="label-text-alt text-error">{{ form.notes.errors.0 }}</span>
                    </label>
                    {% endif %}
                    <label class="label">
                        <span class="label-text-alt">Optional session notes</span>
                    </label>
                </div>
                
                <div class="form-control mt-4" id="backdatedReasonContainer" style="display:none;">
                    <label class="label"><span class="label-text font-semibold">Backdated Reason *</span></label>
                    {{ form.backdated_reason }}
                    {% if form.backdated_reason.errors %}
                    <label class="label">
                        <span class="label-text-alt text-error">{{ form.backdated_reason.errors.0 }}</span>
                    </label>
                    {% endif %}
                    <label class="label">
                        <span class="label-text-alt">Required for past dates</span>
                    </label>
                </div>
                
                <div class="card-actions justify-end mt-6">
                    <a href="{% url 'attendance:today' %}" class="btn btn-ghost">Cancel</a>
                    <button type="submit" class="btn btn-primary">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                        </svg>
                        Mark Attendance
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- jQuery (required for Select2) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
$(document).ready(function() {
    console.log('Attendance form initialized');
    
    // Initialize Select2 for Student dropdown
    $('#id_student').select2({
        placeholder: 'Type to search for student...',
        allowClear: true,
        width: '100%'
    });
    
    // Disable and initialize Subject dropdown
    $('#id_assignment').prop('disabled', true).select2({
        placeholder: 'Select student first...',
        allowClear: true,
        width: '100%'
    });
    
    // Disable and initialize Topics dropdown
    $('#id_topics_covered').prop('disabled', true).select2({
        placeholder: 'Select subject first...',
        allowClear: true,
        width: '100%',
        multiple: true
    });
    
    // When student is selected, fetch their subjects
    $('#id_student').on('select2:select select2:clear', function(e) {
        console.log('Student changed:', e.type);
        const studentId = $(this).val();
        const assignmentSelect = $('#id_assignment');
        const topicsSelect = $('#id_topics_covered');
        const subjectsLoadingMessage = $('#subjectsLoadingMessage');
        
        console.log('Selected student ID:', studentId);
        
        // Clear dependent fields
        assignmentSelect.val(null).trigger('change');
        topicsSelect.val(null).trigger('change');
        
        if (studentId) {
            // Show loading state
            subjectsLoadingMessage.show();
            assignmentSelect.prop('disabled', true);
            
            console.log('Fetching subjects for student:', studentId);
            
            // Fetch subjects for this student
            $.ajax({
                url: `/attendance/api/student-subjects/${studentId}/`,
                method: 'GET',
                success: function(data) {
                    console.log('Subjects received:', data);
                    
                    // Clear existing options
                    assignmentSelect.empty();
                    
                    if (data.assignments && data.assignments.length > 0) {
                        // Add placeholder
                        assignmentSelect.append(new Option('Select subject...', '', false, false));
                        
                        // Add subjects
                        data.assignments.forEach(assignment => {
                            const optionText = assignment.subject_name + 
                                (assignment.subject_code ? ` (${assignment.subject_code})` : '');
                            assignmentSelect.append(new Option(optionText, assignment.id, false, false));
                        });
                        
                        // Enable the dropdown
                        assignmentSelect.prop('disabled', false);
                        
                        // Reinitialize Select2
                        assignmentSelect.trigger('change');
                        
                        // Auto-select if only one subject
                        if (data.assignments.length === 1) {
                            assignmentSelect.val(data.assignments[0].id).trigger('change');
                            console.log('Auto-selected single subject');
                        }
                    } else {
                        assignmentSelect.append(new Option('No subjects assigned', '', false, false));
                        assignmentSelect.prop('disabled', true);
                        console.log('No subjects found for student');
                    }
                    
                    subjectsLoadingMessage.hide();
                },
                error: function(xhr, status, error) {
                    console.error('Error loading subjects:', error, xhr.responseText);
                    assignmentSelect.empty();
                    assignmentSelect.append(new Option('Error loading subjects', '', false, false));
                    assignmentSelect.prop('disabled', true);
                    subjectsLoadingMessage.hide();
                }
            });
        } else {
            // No student selected
            assignmentSelect.empty();
            assignmentSelect.append(new Option('Select student first...', '', false, false));
            assignmentSelect.prop('disabled', true).trigger('change');
            
            topicsSelect.empty();
            topicsSelect.prop('disabled', true).trigger('change');
            subjectsLoadingMessage.hide();
        }
    });
    
    // Auto-filter topics by subject (when assignment changes)
    // Use both Select2 events AND regular change event as fallback
    $('#id_assignment').on('select2:select select2:clear change', function(e) {
        console.log('Subject changed:', e.type);
        const assignmentId = $(this).val();
        const topicsSelect = $('#id_topics_covered');
        const loadingMessage = $('#topicsLoadingMessage');
        
        console.log('Selected assignment ID:', assignmentId);
        
        // Clear topics
        topicsSelect.val(null).trigger('change');
        
        // Check if valid assignment ID (not empty, not placeholder)
        if (assignmentId && assignmentId !== '' && !isNaN(assignmentId)) {
            // Show loading message
            loadingMessage.show();
            topicsSelect.prop('disabled', true);
            
            console.log('Fetching topics for assignment:', assignmentId);
            
            // Fetch topics for this assignment
            $.ajax({
                url: `/attendance/api/topics/${assignmentId}/`,
                method: 'GET',
                success: function(data) {
                    console.log('Topics received:', data);
                    
                    topicsSelect.empty();
                    
                    if (data.topics && data.topics.length > 0) {
                        data.topics.forEach(topic => {
                            topicsSelect.append(new Option(topic.name, topic.id, false, false));
                        });
                        
                        // Enable and refresh
                        topicsSelect.prop('disabled', false);
                        topicsSelect.trigger('change');
                        
                        // Auto-select if only one topic
                        if (data.topics.length === 1) {
                            topicsSelect.val([data.topics[0].id]).trigger('change');
                            console.log('Auto-selected single topic');
                        }
                        
                        console.log('Topics dropdown updated successfully');
                    } else {
                        topicsSelect.append(new Option('No topics available', '', false, false));
                        topicsSelect.prop('disabled', true);
                        console.log('No topics found for subject');
                    }
                    
                    loadingMessage.hide();
                },
                error: function(xhr, status, error) {
                    console.error('Error loading topics:', error);
                    console.error('Response:', xhr.responseText);
                    console.error('Status:', xhr.status);
                    topicsSelect.empty();
                    topicsSelect.append(new Option('Error loading topics', '', false, false));
                    topicsSelect.prop('disabled', true);
                    loadingMessage.hide();
                }
            });
        } else {
            // No assignment selected or invalid ID
            console.log('No valid assignment selected, clearing topics');
            topicsSelect.empty();
            topicsSelect.prop('disabled', true);
            loadingMessage.hide();
        }
    });
    
    // Show backdated reason if past date
    $('#id_date').on('change', function() {
        const selectedDate = new Date($(this).val());
        const today = new Date();
        today.setHours(0,0,0,0);
        
        if (selectedDate < today) {
            $('#backdatedReasonContainer').slideDown();
        } else {
            $('#backdatedReasonContainer').slideUp();
        }
    });
    
    // Check on page load if date is in the past
    const currentDate = $('#id_date').val();
    if (currentDate) {
        const selectedDate = new Date(currentDate);
        const today = new Date();
        today.setHours(0,0,0,0);
        
        if (selectedDate < today) {
            $('#backdatedReasonContainer').show();
        }
    }
    
    // Debug form submission
    $('#attendanceForm').on('submit', function(e) {
        console.log('Form submitting...');
        console.log('Student:', $('#id_student').val());
        console.log('Assignment:', $('#id_assignment').val());
        console.log('Date:', $('#id_date').val());
        console.log('In Time:', $('#id_in_time').val());
        console.log('Out Time:', $('#id_out_time').val());
        console.log('Topics:', $('#id_topics_covered').val());
        
        // Check if required fields are filled
        if (!$('#id_student').val()) {
            alert('Please select a student');
            e.preventDefault();
            return false;
        }
        if (!$('#id_assignment').val()) {
            alert('Please select a subject');
            e.preventDefault();
            return false;
        }
        
        console.log('Form validation passed, submitting...');
    });
});
</script>
{% endblock %}
